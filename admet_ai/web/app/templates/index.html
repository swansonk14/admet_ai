<!DOCTYPE html>
<html lang="en">
{% from 'macros.html' import chemdraw, error_message, warning_message %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='scripts/predict.js')}}"></script>
    <script>
        // Heartbeat to indicate that the user is still interacting with the session
        function sendHeartbeat() {
            fetch('/heartbeat', {method: 'POST'});
        }

        setInterval(sendHeartbeat, "{{ heartbeat_frequency * 1000 }}");
    </script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel='stylesheet' id='classic-theme-styles-css'
          href='https://greenstonebio.com/wp-includes/css/classic-themes.min.css?ver=6.2.2' media='all'/>
    <link type="text/css" rel="stylesheet" href="{{ url_for('static', filename='stylesheets/style.css') }}">
    <title>ADMET-AI</title>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid" style="margin-top: 20px; margin-bottom: 20px">
        <div class="navbar-header">
            <a href="https://admet.ai.greenstonebio.com"><img src="../static/images/ADMET.jpg" alt="ADMET AI Logo"
                                                              style="width:70px;height:70px;"/></a>
            <h3 style="display: inline">ADMET AI</h3>
        </div>
    </div>
</nav>

<div class="container" id="description">
    <h1>ADMET-AI</h1>
    <p style="font-size: 18px;">
        <b>ADMET-AI</b> is a simple, fast, and accurate web interface for predicting the <b>A</b>bsorption,
        <b>D</b>istribution,
        <b>M</b>etabolism, <b>E</b>xcretion, and <b>T</b>oxicity (ADMET) properties of molecules using machine learning
        models.
    </p>

    <br>

    <button id="backgroundCollapseButton" class="btn btn-link2 collapse-button" type="button" data-toggle="collapse"
            data-target="#backgroundText" aria-expanded="false" aria-controls="backgroundText">
        <strong style="font-size: 22px">Background</strong>
        <div id="backgroundArrow" class="arrow arrow-down"></div>
    </button>
    <div id="backgroundText" class="collapse">
        <p>
            The evaluation of pharmacokinetics and toxicity is crucial for the design of new therapeutic candidates.
            In silico virtual screens and generative AI approaches output a vast number of molecules that must be
            filtered to a tractable number for synthesis and experimental validation. An effective primary filter
            is needed for the evaluation of the candidate compounds for their ADMET profiles.
        </p>
        <p>
            ADMET-AI uses a graph neural network called Chemprop-RDKit, which was trained on 41 ADMET datasets from
            the <a href="https://tdcommons.ai/">Therapeutics Data Commons</a> (TDC). ADMET-AI’s Chemprop-RDKit model has
            the
            highest average rank on the
            TDC ADMET Benchmark Group <a href="https://tdcommons.ai/benchmark/admet_group/overview/">Leaderboard</a> and
            it
            is also currently the fastest web-based ADMET predictor.</p>
        <p>
            The details regarding the training and evaluation of the model are described in an article titled: A novel
            machine
            learning ADMET platform for evaluation of large-scale chemical libraries.
        </p>
        <p>
            The predictor has been applied to evaluate cardiovascular drugs and drugs with cardiovascular effects in an
            article
            titled: ADMET profiles of known cardiovascular drugs accurately predicted using a novel machine learned
            predictor.
        </p>
    </div>

    <br><br>

    <button id="useCollapseButton" class="btn btn-link2 collapse-button" type="button" data-toggle="collapse"
            data-target="#useText" aria-expanded="false" aria-controls="useText">
        <strong style="font-size: 22px">Use</strong>
        <div id="useArrow" class="arrow arrow-down"></div>
    </button>
    <div id="useText" class="collapse">
        <p>
            ADMET-AI can make predictions for up to {{ max_molecules }} molecules at a time by either (1)
            providing SMILES (one per line) in the text box, (2) uploading a CSV file with SMILES in the
            first column, or (3) drawing a molecule using the interactive tool and converting it to a SMILES.
            ADMET-AI can make predictions for roughly 30 molecules per second.
        </p>
        <p>
            For regression ADMET properties, the property value is directly predicted with the units shown. For
            classification ADMET properties, the prediction value is the probability of the molecule having that
            property (e.g., probability of blood-brain barrier penetration).
        </p>
        <p>
            For context, the ADMET predictions are
            compared to a set of 2,579 molecules from the DrugBank that have received regulatory approval, and the
            percentile of each prediction is shown with respect to this set of DrugBank molecules. This reference
            set
            can be filtered to a specific category of drugs for a more relevant comparison by selecting an <a
                href="https://www.whocc.no/atc_ddd_index/">Anatomical
            Therapeutic Chemical</a> (ATC) code from the dropdown menu below.
        </p>
        <p>
            Note: ADMET-AI does NOT store any molecules uploaded to the website. All molecules are deleted after
            predictions are made.
        </p>
    </div>

    <br><br>

    <button id="localCollapseButton" class="btn btn-link2 collapse-button" type="button" data-toggle="collapse"
            data-target="#localText" aria-expanded="false" aria-controls="localText">
        <strong style="font-size: 22px">Local Prediction</strong>
        <div id="localArrow" class="arrow arrow-down"></div>
    </button>
    <div id="localText" class="collapse">
        <p>ADMET-AI can also be run locally as a command line tool for large-scale batch prediction or as a Python
            module
            for use within other Python-based tools (e.g., as a reward for a generative AI model for drug design).
            Please
            see <a href="https://github.com/swansonk14/admet_ai">https://github.com/swansonk14/admet_ai</a>
        </p>
    </div>
</div>

<div class="container" id="content">
    <h2>Predict</h2>

    <form enctype="multipart/form-data" method="POST">
        <!--SMILES upload type selector-->
        <div class="btn-group" id="inputSelect" data-toggle="buttons">
            <label id="textButton" class="btn btn-primary active">
                <input type="radio" name="inputType" value="text" autocomplete="off"> Text Input
            </label>
            <label id="fileButton" class="btn btn-primary">
                <input type="radio" name="inputType" value="file" autocomplete="off"> Upload File
            </label>
            <label id="drawButton" class="btn btn-primary">
                <input type="radio" name="inputType" value="button" autocomplete="off"> Draw Molecule
            </label>
            <label id="exampleButton" class="btn btn-primary">
                <input type="radio" name="inputType" value="button" autocomplete="off"> Example
            </label>
        </div>

        {% if max_molecules %}
        <h5><b>Note:</b> Predictions can be made for at most {{ "{:,}".format(max_molecules) }} molecules at a time.
        </h5>
        {% endif %}

        <!--SMILES input-->
        <div id="textInputForm">
            <h5>SMILES (one per line)</h5>
            <textarea id="textSmilesInput" name="textSmiles" cols="100" rows="10" placeholder="SMILES"
                      style="width: 100%" required></textarea>
        </div>
        <div id="fileInputForm" style="display:none">
            <h5>CSV file containing SMILES in the provided column</h5>
            <div id="fileInput" style="display: flex; align-items: center;">
                <input id="fileSmilesInput" type="file" name="data" accept=".csv">
                <span style="margin-right: 5px"><b>SMILES column: </b></span>
                <input id="fileSmilesColumn" name="smilesColumn" placeholder="SMILES column" value="smiles">
            </div>
        </div>
        <div id="drawInputForm" style="display:none">
            <h5>Draw a molecule</h5>
            {{ chemdraw() }}
            <br>
            <button type="button" id="convertToSmiles" class="btn btn-primary btn-xs">Convert to SMILES</button>
            <input id="drawSmilesInput" name="drawSmiles" placeholder="SMILES">
        </div>

        <br>

        <button type="submit" class="btn btn-primary btn-md">Predict</button>
    </form>

    {% if drugbank_plot %}
    <br>
    <br>

    <button id="drugbankCollapseButton" class="btn btn-link2 collapse-button" type="button" data-toggle="collapse"
            data-target="#drugbank" aria-expanded="false" aria-controls="drugbank">
        <strong style="font-size: 22px">DrugBank Comparison Plot</strong>
        <div id="drugbankArrow" class="arrow arrow-down"></div>
    </button>
    <div id="drugbank" class="collapse">
        <div id="drugbank-plot" style="flex: 1; text-align: center;">
            <div id="drugbank-plot-inner" style="width: 60%; display: inline-block;">
                {{ drugbank_plot | safe }}
            </div>
        </div>

        <br>

        <div id="drugbank-plot-controls" style="text-align: center">
            <div class="dropdown" style="display: inline">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    Select ATC Code
                </button>
                <div class="dropdown-menu">
                    <input class="form-control" id="atc-selection" type="text" placeholder="Search..">
                    <li>
                        {% for atc_code in drugbank_atc_codes %}
                        <a class="dropdown-item atc-item" style="cursor: pointer">{{ atc_code }}</a>
                        {% endfor %}
                    </li>
                </div>
            </div>

            {% for axis in ["x", "y"] %}
            <div class="dropdown" style="display: inline">
                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
                    Select DrugBank {{ axis }}-axis property
                </button>
                <div class="dropdown-menu">
                    <input class="form-control" id="drugbank-{{ axis }}-axis-selection" type="text"
                           placeholder="Search..">
                    <li>
                        {% for task in drugbank_tasks %}
                        <a class="dropdown-item drugbank-{{ axis }}-axis-item" style="cursor: pointer">{{ task }}</a>
                        {% endfor %}
                    </li>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <br>
    {% endif %}

    {% if warnings %}
    {% for warning in warnings %}
    {{ warning_message(warning) }}
    {% endfor %}
    {% endif %}

    {% if errors %}
    {% for error in errors %}
    {{ error_message(error) }}
    {% endfor %}
    {% endif %}

    {% if predicted %}
    <hr>

    <a href="{{ url_for('download_predictions') }}">
        <button class="btn btn-default btn-md">Download Results</button>
    </a>

    <br><br>

    <ul id="list">
        {% for smiles_index in range(num_display_molecules) %}
        {% set smiles = all_smiles[smiles_index] %}

        <li class="index" style="margin-top: 25px;">
            <button id="molecule{{ smiles_index }}CollapseButton" class="btn btn-link2 collapse-button" type="button"
                    data-toggle="collapse"
                    data-target="#collapseInfo{{ smiles_index }}" aria-expanded="false"
                    aria-controls="collapseInfo{{ smiles_index }}"
                    style="height: 200px;">
                <strong style="font-size: x-large; text-wrap: wrap; overflow: hidden; text-overflow: ellipsis;">Molecule
                    {{ smiles_index + 1 }}: {{
                    smiles }} </strong>
                <div class="svg-container" style="margin-left: auto; height: 100%; display: flex; flex-shrink: 0;">
                    <div id="radial-plot{{ smiles_index }}" class="radial-plot"
                         style="margin-left: 20px; height: 100%;">
                        {{ radial_svgs[smiles_index] | safe }}
                    </div>
                    <div id="molecule-image{{ smiles_index }}" class="mol-image"
                         style="margin-left: 20px; height: 100%;">
                        {{ mol_svgs[smiles_index] | safe }}
                    </div>
                </div>
                <div id="molecule{{ smiles_index }}Arrow" class="arrow arrow-down" style="margin-left: 10px"></div>
                <script>
                    $(document).ready(function () {
                        let buttonName = `molecule{{ smiles_index }}`;
                        $(`#${buttonName}CollapseButton`).click(function () {
                            let arrow_div = $(`#${buttonName}Arrow`);
                            arrow_div.toggleClass("arrow-up");
                            arrow_div.toggleClass("arrow-down");
                        });
                    });
                </script>
            </button>

            <div id="collapseInfo{{ smiles_index }}" class="collapse">
                <div style="display: flex; flex-wrap: wrap;">
                    {% for category in ["Physicochemical", "Absorption", "Distribution", "Metabolism", "Excretion",
                    "Toxicity"] %}
                    <div style="flex: 1; width: 100%;">
                        <div style="display: flex;">
                            <img src="../static/images/{{ category.lower() }}.jpg" alt="{{ category }}"
                                 style="width:50px; height:50px; margin-left: 20px;"/>
                            <h3 class="table_header">{{ category }}</h3>
                        </div>

                        <table style="width: 95%; margin: 10px;">
                            <thead>
                            <tr>
                                <th>Model</th>
                                <th>{{ "Value" if category == "Physicochemical" else "Prediction" }}</th>
                                <th>DrugBank Percentile{{ " (ATC filter)" if session.get("atc_code", "all") != "all"
                                    else "" }}
                                </th>
                                <th>Units</th>

                            </tr>
                            </thead>
                            <tbody>
                            {% set category_info = admet_info[admet_info["category"] == category] %}
                            {% for _, row in category_info.iterrows() %}

                            <tr>
                                <td><strong>
                                    <a href={{ row["url"] }} target="_blank" class="data_link">
                                    {{ row["name"] }}
                                    </a>
                                    {% if category != "Physicochemical" %}
                                    {% if row["task_type"] == "classification" %}
                                    {% set first_metric = "AUROC" %}
                                    {% set second_metric = "AUPRC" %}
                                    {% else %}
                                    {% set first_metric = "R^2" %}
                                    {% set second_metric = "MAE" %}
                                    {% endif %}
                                    <span
                                            class="glyphicon glyphicon-question-sign"
                                            style="font-size:15px"
                                            data-toggle="tooltip"
                                            data-html="true"
                                            data-placement="right"
                                            title="Dataset Size: {{ '{:,.0f}'.format(row['size']) }}<br>
                                            {{ string_to_html_sup('{}: {:.2f}'.format(first_metric, row[first_metric])) | safe }}<br>
                                            {{ string_to_html_sup('{}: {:.2f}'.format(second_metric, row[second_metric])) | safe }}
                                            {{ '<br>TDC Leaderboard Rank: {}'.format(row['tdc_rank']) if row['tdc_rank'] != '-' else '' }}">
                                                                </span>
                                    {% if row[first_metric] < low_performance_threshold %}
                                    <span
                                            class="glyphicon glyphicon-warning-sign"
                                            style="font-size:15px" data-toggle="tooltip"
                                            data-placement="right"
                                            title="Lower accuracy">
                                                                            </span>
                                    {% endif %}
                                    {% endif %}
                                </strong></td>

                                <td>
                                    {% set pred = smiles_to_property_to_pred[smiles][row["id"]] %}
                                    {{ ("{:.2f}" if pred > 0.005 or pred < -0.005 else "{:.2e}").format(pred) }}
                                </td>

                                <td>
                                    {{
                                    "{:.2f}".format(smiles_to_property_to_pred[smiles][row["id"] + "_" +
                                    drugbank_approved_percentile_suffix])
                                    }}%
                                <td>
                                    {{ string_to_html_sup(row["units"]) | safe }}
                                </td>

                            </tr>

                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <br>
        </li>
        {% endfor %}
    </ul>

    {% if num_molecules > num_display_molecules %}
    <p>... and {{ num_molecules - num_display_molecules }} more. Download for full predictions.</p>
    {% endif %}
    {% endif %}

</div>

<nav class="navbar navbar-inverse navbar-fixed-bottom">
    <div class="container-fluid">
        <p class="navbar-text pull-left"><a href="https://admet.ai.greenstonebio.com">ADMET-AI</a> is a collaboration
            between <a href="https://greenstonebio.com/">Greenstone Biosciences</a> and <a
                    href="https://www.james-zou.com/">Prof. James Zou's lab</a> at Stanford University © 2023. <a
                    href="https://github.com/swansonk14/admet_ai">Source Code</a>.</p>
    </div>
</nav>
</body>
</html>
